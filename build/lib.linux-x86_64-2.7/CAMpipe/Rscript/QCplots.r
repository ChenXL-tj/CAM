bi_siteheat<-function(data0,usecolor,p){
data<-data0
data <- c(as.matrix(data))
data <- sort(data)
min <- data[1]
max <- data[length(data)]
temp<-data[round(c(0.010000,0.5,p)*length(data))]
p20<-temp[1]
p50<-temp[2]
p80<-temp[3]
zmin=p20
zmax=p80
ColorRamp <- colorRampPalette(usecolor, bias=1)(10000)   #color list
ColorLevels <- seq(to=zmax,from=zmin, length=10000)   #number sequence
data0[data0<zmin] <- zmin
data0[data0>zmax] <- zmax

ColorRamp_ex <- ColorRamp[round( (min(data0)-zmin)*10000/(zmax-zmin) ) : round( (max(data0)-zmin)*10000/(zmax-zmin) )]

par(mar=c(1,4,1,2))
image(1:ncol(data0), 1:nrow(data0), t(data0), axes=F, col=ColorRamp_ex, xlab="", ylab="",main="",useRaster=T)
box()
par(mar=c(2,4,1,2))
image(ColorLevels,1,matrix(data=ColorLevels, nrow=length(ColorLevels),ncol=1),col=ColorRamp, xlab="",ylab="",cex.axis=1,xaxt="n",yaxt="n",useRaster=T)
axis(side=1)
}


NFRscore_generate <- function(inline){
	N <- length(inline)
	A <- ksmooth(1:N,as.numeric(inline),"normal",bandwidth=BW)$y
	aleft <- A[1:(N-2)]
	amid <- A[2:(N-1)]
	aright <- A[3:N]
	localmaxID <- which(amid > aleft & amid > aright)
	localminID <- which(amid < aleft & amid < aright)
 
    p1 <- localmaxID[which(localmaxID>100)][1]
    m1 <- localmaxID[which(localmaxID<100)][length(which(localmaxID < 100))]
    nfr<- localminID[which(localminID<100)][length(which(localminID<100))]
   
    p1height <- A[p1+1]
    m1height <- max(A[70:84])
    nfrheight <- min(A[85:100])
    globalMAX <- max(A)
    globalMIN <- min(A)
    NFRscore <- (((p1height + m1height)/2) - nfrheight) / (globalMAX - globalMIN)
    return(NFRscore)
}

promoter_array_score_generate <- function(inline){
	N <- length(inline)
	A <- ksmooth(1:N,as.numeric(inline),"normal",bandwidth=BW)$y
	aleft <- A[1:(N-2)]
	amid <- A[2:(N-1)]
	aright <- A[3:N]
	localmaxID <- which(amid > aleft & amid > aright)
	localminID <- which(amid < aleft & amid < aright)
    parray <- localmaxID[which(localmaxID>100)]
    if (length(parray) < 4){return(100)
    }else{
    	return(sd(parray[2:4]-parray[1:3])/mean(parray[2:4]-parray[1:3]))
    }
}



seqcov_distribution <- c(13.8602,41.4113,28.7638,2.5676,17.0390,7.0893,10.4359,5.2965,3.4660,3.5850,2.2153,4.1624,1.6935,2.4335,2.2537,2.5918,2.0968,1.7467,2.2472,2.2871,1.8716,2.0399,1.8602,1.8032,2.7721,3.2589,3.3238,2.3584,2.3957,3.1341,3.0849,2.5910,2.7888,2.4676,2.5823,2.1415,1.7027,2.1825,2.2825,1.8360,2.0684,2.2034,2.8989,2.5079,2.8940,2.8488,2.1865,1.9753,1.8804,1.9657,2.1340,1.8850,2.1409,2.1996,1.9151,2.3644,2.2167,1.6897,1.5880,12.5006,11.9705,12.3368,14.6810,12.1252,10.5817,13.3637,13.6870,10.9433,10.8491,13.3534,24.6210,8.5994,8.9250,19.8701,53.4853,22.6459,24.3644,34.6402,34.3559,33.6696,12.5850,11.6888,11.6117,3.8227,1.8566,1.0718,0.7810,2.0221,17.0390,16.6683,2.1397,0.5819,7.2807,6.0076,14.4324,3.2410,15.5844,14.0256,4.2522,1.9443,3.3621,3.4207,2.3047,3.9056,3.9770,6.4307,3.6006,3.6646,5.5199,3.4198,3.4802,5.0984,6.3122,5.3131,3.4798,5.1193,28.8136,25.1241,20.3812,21.0870,14.6885,14.5641,15.7866,12.8259,10.6111,8.3507,9.4780,10.1516,9.6836,11.6735,10.6962,3.2844,3.9791,4.2197,3.0639,9.3526,13.6345,13.1094,10.8706,5.8334,12.4438,8.7566,5.7381,8.9780,5.9217,43.6546,42.2277,0.4865,3.3220,3.4288,6.0891,1.1498,2.2963,2.5999,3.8752,5.4880,7.8156,7.2397,2.2640,4.4573,10.3532,6.3277,17.3787,5.2855,7.8518,9.2274,11.5667,9.4940,9.6050,10.9028,15.4406,15.0467,11.1553,11.5409,14.4928,3.0001,3.0827,9.6156,6.2336,5.8898,2.1056,3.0670,3.2388,3.6151,2.2327,2.5478,4.0371,3.6763,3.5553,4.0078,4.1563,3.5969,3.3331,0.7736,2.6844,3.1825,3.1839,3.6739,2.1353,2.7432,3.4604,3.9887,2.9243,3.4716,3.7229,3.6329,3.0123,2.8568,1.7368,2.9242,13.3786,12.8374,113.3057,84.7239,15.3911,15.2774,14.1242,14.0537,14.0767,14.1842,17.0789,15.3818,14.9888,14.9831,15.1119,14.9932,8.6230,6.4399,7.3014,25.0852,57.3203,25.7268,39.5131,15.6916,15.3791,16.0371,14.7682,15.4319,14.9880,1.2724,1.6287,13.3847,15.1170,13.8680,13.7537,9.8083,7.4986,7.7236,1.9982,1.3366,14.3136,12.8883,12.3895,34.1288,6.1023,12.6526,13.8984,13.1487,3.5895,115.9329,43.1060,6.3161,5.7415,6.2687,5.8263,10.9837,5.3129,5.8797,2.5042,4.5850,8.0064,10.2947,10.1029,7.7769,10.4851,11.0810,9.1405,8.9073,0.9244,1.0791,0.1676,0.1467,7.7931,3.7762,4.2325,2.4620,1.3444,2.1213,1.8330,1.9237,0.7683,0.7944,0.9558,0.9706,0.7163,0.9592,1.1011,0.9404,1.0146,7.5631,25.0987,1.2483,0.9143,1.1381,1.7544,30.6574,33.1108,5.1130,3.2961,3.3899,6.6014,6.0540,9.4694,1.5814,10.3456,9.5732,10.2374,7.2954,6.8831,3.8570,4.1142,5.9329,4.4753,4.8965,4.2171,4.0291,4.2661,1.9305,3.0829,3.2544,4.1483,6.1611,8.2194,39.2976,32.3707,22.4675,32.3744,22.1588,38.3852,44.9455,11.0744,116.8194,40.5238,5.0061,4.2878)
rotational_distribution <- c(0.1890,0.1269,0.1066,0.0802,0.1639,0.2334,0.3412,0.0387,0.0437,0.1843,0.2047,0.2070,0.1292,0.0867,0.1034,0.1070,0.0802,0.1006,0.0860,0.0939,0.1112,0.1055,0.0751,0.1110,0.1425,0.1269,0.1405,0.1281,0.1284,0.1207,0.1475,0.1433,0.1469,0.1444,0.1330,0.1281,0.0849,0.0822,0.1010,0.0730,0.0747,0.0846,0.1424,0.1224,0.1471,0.1471,0.1551,0.0879,0.0744,0.0917,0.0830,0.0839,0.0888,0.0792,0.0641,0.0857,0.0873,0.0904,0.0923,0.0867,0.0854,0.1670,0.1523,0.2050,0.2149,0.1461,0.1695,0.2427,0.2402,0.3858,0.1830,0.0532,0.0521,0.0188,0.0542,0.0541,0.1383,0.0846,0.0853,0.0828,0.0917,0.1076,0.0878,0.1602,0.2614,0.1711,0.1224,0.2176,0.1636,0.1528,0.0331,0.0309,0.0777,0.1613,0.0187,0.0104,0.1221,0.0750,0.1962,0.0468,0.0492,0.0494,0.0542,0.0522,0.0532,0.2103,0.2109,0.2105,0.2077,0.2086,0.2111,0.1737,0.1935,0.1842,0.1924,0.1988,0.2109,0.2417,0.2795,0.3008,0.1231,0.0629,0.0206,0.1130,0.1232,0.1278,0.1466,0.0773,0.0788,0.1378,0.1237,0.0105,0.0123,0.0439,0.0316,0.0640,0.0120,0.0762,0.0896,0.1163,0.1110,0.0511,0.0371,0.0585,0.0410,0.1043,0.1058,0.1037,0.1652,0.1413,0.1578,0.2057,0.0456,0.0469,0.1123,0.1021,0.0695,0.0690,0.1067,0.1113,0.0730,0.1056,0.0844,0.0877,0.0795,0.0668,0.0425,0.0331,0.0326,0.3500,0.1285,0.0590,0.0656,0.0492,0.0624,0.0560,0.0607,0.1361,0.0246,0.0125,0.0119,0.0215,0.0568,0.0956,0.0072,0.0226,0.0607,0.0982,0.0958,0.1870,0.2312,0.0236,0.0912,0.1842,0.1997,0.0545,0.0896,0.1239,0.0130,0.0434,0.0975,0.1372,0.0296,0.1104,0.1777,0.1963,0.0269,0.0791,0.1389,0.1546,0.0867,0.0766,0.1559,0.2799,0.0832,0.0809,0.0830,0.0812,0.0800,0.0800,0.1382,0.1375,0.1339,0.1340,0.1343,0.1353,0.0650,0.1133,0.1171,0.1186,0.1662,0.1253,0.1780,0.2493,0.2096,0.1626,0.2108,0.0177,0.0296,0.0494,0.0607,0.1105,0.0866,0.0958,0.1061,0.0921,0.1344,0.0935,0.0379,0.0342,0.1780,0.2103,0.1547,0.1832,0.3734,0.0792,0.0697,0.2181,0.2088,0.1543,0.1572,0.4174,0.3865,0.3989,0.4098,0.2686,0.0649,0.0589,0.0449,0.0201,0.0463,0.0492,0.0534,0.0120,0.1180,0.1158,0.0547,0.0195,0.1952,0.1903,0.1648,0.1489,0.1954,0.1470,0.1357,0.1659,0.0502,0.2559,0.0631,0.3279,0.2183,0.2065,0.1856,0.1979,0.2143,0.2261,0.2166,0.2164,0.1838,0.2101,0.1647,0.0271,0.0307,0.0332,0.0288,0.0621,0.0588,0.0891,0.1615,0.1661,0.2143,0.2132,0.2595,0.1229,0.0134,0.0112,0.0768,0.0673,0.0672,0.0654,0.0698,0.0863,0.0787,0.0834,0.1232,0.1193,0.1381,0.1304,0.1373,0.1301,0.1336,0.1284,0.2265,0.2957,0.3259,0.2050,0.3294,0.2402,0.1340,0.2407,0.2221,0.0846,0.0921,0.6156,0.3619 )
fraglen_distribution <- c(175,152,154,155,158,160,100,151,163,164,148,148,148,166,165,168,167,168,168,166,174,173,174,173,174,166,173,165,174,173,173,174,174,174,174,175,173,173,173,173,172,174,174,174,174,173,173,174,176,173,174,174,174,174,174,174,174,174,175,151,151,150,151,149,147,150,149,148,147,128,148,107,107,166,161,140,139,128,127,128,128,127,128,150,149,148,172,148,160,152,152,156,166,145,184,185,148,147,147,169,168,167,168,168,168,149,149,149,148,148,148,168,161,161,151,151,149,152,148,149,148,145,163,149,148,150,150,148,148,150,151,157,157,157,157,165,140,138,150,148,149,146,140,146,139,148,148,152,148,148,148,148,159,159,151,172,170,177,168,169,170,172,167,169,171,172,139,100,108,148,147,160,160,160,160,168,168,150,153,152,171,166,155,147,171,166,154,147,157,147,128,169,157,147,128,158,152,129,171,163,152,128,168,149,147,127,168,153,147,128,148,148,155,149,148,148,148,148,148,148,129,129,129,129,148,129,148,147,146,149,147,149,148,149,150,150,149,161,159,159,152,147,147,147,147,106,148,149,167,169,115,146,115,150,151,160,168,156,170,148,149,148,148,148,148,152,150,149,157,150,156,156,148,158,148,148,158,160,150,150,152,151,150,151,151,147,149,147,156,147,148,149,149,149,149,149,149,149,149,150,150,182,183,176,181,129,128,150,147,128,148,148,100,147,157,154,148,150,152,153,153,151,150,151,151,153,151,151,150,150,150,150,150,149,152,149,152,149,152,149,149,148,148,148,157)
NFR_distribution <- c(0.2659,0.2813,0.3440,0.5316,0.2690,0.9138,0.6253,0.5767,0.3971,0.7343,0.7683,0.7854,0.6593,0.6139,0.6075,0.6715,0.6128,0.6495,0.6508,0.6933,0.7107,0.6852,0.6746,0.7021,0.7919,0.8190,0.7995,0.7490,0.7717,0.7546,0.7927,0.8141,0.8271,0.7880,0.7973,0.7769,0.6878,0.6649,0.7265,0.6459,0.7267,0.6623,0.8251,0.8395,0.8142,0.8134,0.8236,0.7173,0.7053,0.7210,0.7129,0.6898,0.6939,0.7296,0.7048,0.7119,0.7246,0.7348,0.7360,0.1301,0.1380,0.7863,0.7405,0.6929,0.7404,0.9275,0.8112,0.7734,0.7516,0.4239,0.9294,0.6519,0.6717,0.3563,0.7348,0.7568,0.7801,0.5330,0.5031,0.4802,0.7563,0.6443,0.7380,0.4567,0.7374,0.4617,0.5222,0.7606,0.2690,0.2721,0.6504,0.7281,0.6981,0.8216,0.6314,0.6098,0.7695,0.6933,0.8064,0.3753,0.3895,0.3779,0.3701,0.3680,0.3798,0.4246,0.4234,0.4353,0.4505,0.4342,0.4178,0.1625,0.0992,0.7072,0.3348,0.6098,0.9464,0.6694,0.8442,0.5966,0.7781,0.2991,0.5742,0.8358,0.6799,0.6137,0.8272,0.6969,0.5134,0.7613,0.6940,0.2681,0.3055,0.2889,0.3685,0.4633,0.3981,0.6112,0.8242,0.9342,0.9017,0.7704,0.7411,0.7558,0.7351,0.4048,0.3916,0.6058,0.4963,0.4532,0.6858,0.6704,0.4710,0.4467,0.5371,0.1979,0.2773,0.2570,0.3629,0.1673,0.5626,0.0787,0.7834,0.1429,0.3816,0.4737,0.3963,0.3084,0.3856,0.6102,0.7221,0.8673,0.9222,0.9451,0.8392,0.4968,0.3386,0.4759,0.2172,0.2153,0.1860,0.4165,0.9013,0.8478,0.1852,0.4030,0.9072,0.8438,0.5942,0.6635,0.8198,0.3216,0.7829,0.8034,0.7093,0.6678,0.7485,0.7436,0.1528,0.4654,0.8205,0.7196,0.3151,0.5820,0.7033,0.7422,0.2980,0.6992,0.8066,0.6826,0.5849,0.4545,0.8183,0.8489,0.6040,0.5994,0.5967,0.5981,0.5958,0.5942,0.5783,0.5841,0.5749,0.5706,0.5670,0.5735,0.2382,0.7430,0.7412,0.7922,0.6037,0.9168,0.6213,0.7971,0.8409,0.7365,0.8411,0.4603,0.5657,0.1460,0.1406,0.6520,0.6269,0.6679,0.6485,0.3658,0.5518,0.5208,0.1922,0.2418,0.3097,0.3064,0.3068,0.7169,0.5834,0.8704,0.8340,0.7857,0.2228,0.7704,0.8228,0.6943,0.7854,0.6749,0.6882,0.4135,0.2889,0.2655,0.3060,0.4891,0.7013,0.6584,0.6187,0.3848,0.8591,0.7511,0.2564,0.0754,0.8801,0.7981,0.7470,0.5230,0.4295,0.9183,0.8234,0.1469,0.1564,0.1572,0.1627,0.4425,0.7441,0.7162,0.7908,0.8477,0.8969,0.7409,0.6516,0.6299,0.7079,0.2254,0.6230,0.5886,0.9028,0.9530,0.9306,0.5842,0.7531,0.4403,0.7432,0.7782,0.5973,0.5537,0.2479,0.7765,0.6143,0.5504,0.4675,0.2799,0.2954,0.3133,0.2954,0.3293,0.3663,0.3258,0.2998,0.2827,0.2768,0.2530,0.2865,0.2999,0.2783,0.2915,0.7755,0.8830,0.8252,0.7944,0.8150,0.8477,0.8116,0.8241,0.8005,0.4131,0.4772,0.3089,0.3697)
fuzziness_distribution <- c(0.8755,0.6367,0.1732,0.3302,1.1208,0.0866,0.0279,0.1115,0.0912,0.0619,0.0619,0.0833,0.0556,0.6749,0.0917,0.1019,0.0333,0.0588,0.0588,0.1019,0.0666,0.0333,0.0666,0.1176,0.0865,0.0962,0.0556,0.0556,0.1201,0.0654,0.0654,0.1307,0.0630,0.0556,0.0865,0.0865,0.1176,0.0917,0.1019,0.6063,0.1929,0.0666,0.1307,0.0309,0.1178,0.1307,0.0556,0.0654,0.0666,0.0865,0.0315,0.0865,0.0654,0.0556,0.0588,0.0327,0.0327,0.0654,0.1665,0.1468,0.1468,0.0833,0.0833,0.0818,0.0556,0.1053,0.0818,0.0630,0.0315,0.3448,0.0866,0.0630,0.0556,0.1393,0.1053,0.0833,0.0833,0.0865,0.0962,0.0556,0.0333,0.0556,0.0333,0.0315,0.0790,0.1111,0.0790,0.1115,1.1208,1.1384,0.0666,0.0818,0.1666,0.1115,0.2426,0.1732,0.1174,0.1077,0.1493,0.1302,0.1553,0.1058,0.1663,0.1195,0.1663,0.1393,0.1115,0.1823,0.5383,0.1135,0.1195,1.1731,0.1053,0.0619,0.0619,0.1348,0.0833,0.1260,0.0865,0.0833,0.1174,0.7229,0.1855,0.0818,0.1201,0.1452,0.0619,0.0654,0.0654,0.0833,0.0833,0.1393,0.1115,0.1178,0.1452,0.1393,0.8992,0.4335,0.0833,0.0619,0.0962,1.0271,0.9787,1.0278,1.1426,0.9482,0.9342,0.1019,0.0833,0.0818,0.0556,0.4373,0.0912,0.1260,0.0526,1.0016,0.0619,0.0619,0.1053,0.0619,0.0790,0.3632,0.0912,0.0619,0.0526,0.0526,0.0790,0.5005,0.1663,0.0654,0.1580,0.1058,0.1058,0.1058,0.0777,0.1111,1.0011,0.0654,0.8184,0.9889,0.1865,0.1203,0.1007,0.0790,0.2181,0.1832,0.1000,0.1077,0.0976,0.0541,0.0526,0.0716,0.1000,0.1905,0.0309,0.1195,0.1667,0.0912,0.2291,0.1637,0.1115,0.0619,0.1816,0.0587,0.0526,0.0309,0.1136,0.0790,0.0790,0.0309,0.0833,0.0556,0.0790,0.1053,0.0000,0.0333,0.0333,0.0333,0.0000,0.0333,0.0327,0.0327,0.0333,0.0865,0.0327,0.0333,0.8759,0.0309,0.0315,0.0790,0.0790,0.0912,0.0790,0.1115,0.0912,0.0833,0.1115,0.9024,0.2412,0.1115,0.1260,0.0315,0.0865,0.0315,0.0315,0.5388,0.1115,0.5388,0.1634,1.2285,0.7506,0.4575,0.9309,0.1195,0.7110,0.0866,0.0790,0.1115,0.8834,0.0818,0.0790,0.3634,0.3816,0.0587,0.0294,0.7181,0.8357,0.8544,0.8177,0.9900,0.1373,0.1053,0.9637,0.1302,0.0777,0.6768,0.6891,0.1323,0.0790,0.0526,0.1502,0.1053,0.0587,0.0619,0.0833,0.6985,0.6450,0.5004,1.0157,0.6418,0.0500,0.0777,0.1024,0.0790,0.2797,0.0587,0.1393,0.0284,0.0294,0.5991,0.0833,0.0476,0.0825,0.0279,0.0500,0.0315,0.0309,0.1000,0.0294,0.0000,1.1853,0.8321,0.3133,0.0962,0.0865,1.0556,0.8503,0.8820,0.3903,0.2628,0.3055,0.3310,0.3310,0.3844,0.3818,0.3302,0.3818,0.4732,0.7154,0.3975,0.7426,0.3679,0.0619,0.0833,0.0556,0.0556,0.0833,0.0619,0.0833,0.0315,0.0962,0.0500,0.0912,0.6027,0.7639)
utr_distribution <- c(0.7357,0.6996,0.8789,2.4614,3.7979,1.5748,0.7008,2.1491,1.8468,1.4216,1.4104,1.2994,1.2534,1.5917,1.5137,1.4153,1.4931,1.4129,1.4346,1.2717,1.2628,1.2948,1.3891,1.2414,1.0390,1.0420,1.0863,1.2388,1.1128,1.1434,1.0717,1.0799,1.0678,1.0763,1.0852,1.1666,1.3236,1.4035,1.2146,1.4918,1.2542,1.2969,0.9726,0.9793,0.9780,1.0246,0.9359,1.1087,1.1506,1.1344,1.0454,1.1761,1.0911,1.1018,1.1954,1.1245,1.1355,1.1538,1.0631,1.7806,1.5904,1.1336,1.5667,1.3628,1.7503,1.7491,1.8440,1.4714,1.4212,1.0039,3.7639,2.3760,2.6957,1.7428,2.0762,1.5851,1.6589,0.9273,0.8298,0.8811,1.0314,0.7828,1.0574,2.6164,0.9490,1.4780,1.5430,0.7707,3.8005,4.3108,2.8276,1.5876,1.5804,1.5880,1.0072,0.9266,2.2994,1.8521,1.2926,0.7811,0.9410,0.9586,0.8130,0.9483,0.9589,0.8513,0.7279,0.7501,0.8343,0.7138,0.7062,1.1881,1.4112,1.1940,1.7922,1.1635,1.9854,1.3818,1.6149,1.4309,2.1817,0.8005,0.4854,3.8713,2.4638,2.7190,4.1089,2.2573,2.3771,2.8958,2.7642,1.5336,1.9012,2.0407,1.9353,0.6183,1.8385,2.8596,1.8897,1.6175,2.2216,2.0773,2.0838,2.1376,2.1753,2.1231,2.1855,1.5258,1.9588,2.1791,1.8259,1.8599,1.6995,1.7552,2.1976,2.6113,2.6074,2.9669,2.1647,2.5433,2.5231,2.9276,2.7225,2.3037,2.3353,2.4304,0.6930,0.7064,0.8650,1.3267,1.7366,3.0568,3.2312,3.9390,2.8302,1.6157,1.8508,1.5970,1.1858,1.2410,1.2640,1.3301,1.4413,1.6728,1.1670,1.6030,1.4499,1.6129,0.8959,0.9356,1.0928,0.7714,0.8649,0.9251,1.7976,2.1539,1.9494,1.5337,1.6139,2.3101,1.7230,1.7941,0.6439,0.6719,0.8638,1.2415,0.7499,0.8787,1.0948,1.6689,1.8168,1.9548,1.8286,1.6902,2.2426,2.2020,2.2777,2.2819,2.2915,2.3209,1.6648,1.6710,1.6953,1.6863,1.7258,1.7024,2.1159,3.2826,3.9496,3.5378,1.0096,3.4782,1.0247,1.3438,0.7620,0.8646,0.7576,5.4947,3.9023,1.7540,1.7496,1.8258,2.2621,2.4960,1.6341,0.6894,1.3712,1.1410,2.1176,4.3780,0.6841,0.6325,0.7489,1.6452,0.9695,3.1123,3.0152,3.1324,0.9161,2.5842,2.2250,1.8964,2.0027,1.8007,1.7920,1.6043,2.4678,2.4526,2.2579,2.5373,3.2546,3.5309,3.0947,2.3979,1.2673,1.2077,0.6983,0.8722,1.1805,1.2061,1.2952,1.5525,1.6974,2.0287,2.1534,2.6517,3.4211,2.3732,2.5947,1.4949,0.9083,0.8867,0.9379,0.9297,0.9081,0.9014,0.8821,0.8364,0.8870,1.0018,1.6744,1.7816,1.1641,1.4333,1.5899,2.0573,1.7458,1.9234,1.6899,2.2040,1.2400,1.2057,0.8832,2.2678,2.3772,2.6093,2.7640,0.8428,0.8310,0.8779,0.8726,0.9553,0.9651,1.0938,0.9951,0.9847,0.8686,0.8037,0.8869,0.8719,0.9032,0.9416,1.5745,2.1278,2.2553,2.2569,1.8027,2.1859,2.0887,2.3818,1.5419,2.2828,1.8638,0.8041,1.0932)
dhs_distribution <- c(1.8496,2.0579,2.3348,3.2426,3.8142,3.1631,1.7562,3.1565,3.0504,2.9076,2.8748,2.9296,2.6464,2.8670,2.7981,2.7942,2.7705,2.8396,2.7187,2.5449,2.6701,2.5984,2.8163,2.6908,2.4547,2.4418,2.4885,2.5723,2.4787,2.5585,2.4741,2.3904,2.4323,2.4262,2.4443,2.5026,2.8018,2.7389,2.5823,2.9579,2.5751,2.6497,2.3522,2.3394,2.3455,2.4034,2.2415,2.5339,2.5362,2.5469,2.3654,2.6425,2.3938,2.4551,2.5462,2.5033,2.4995,2.5833,2.5745,3.3125,3.1938,2.4653,2.7233,2.9326,3.1887,2.9698,3.0279,3.0809,3.0112,2.4432,4.5930,3.2046,3.3481,3.3214,3.5525,3.1429,3.2515,2.2102,2.1551,2.1092,2.4079,2.0503,2.3902,3.6714,2.5586,3.0272,2.8789,2.2867,3.8148,3.9251,3.6321,2.5040,3.1937,3.2271,2.6656,2.4930,4.0646,3.5097,2.8385,1.7235,1.9795,1.9983,1.7883,2.0692,2.0698,2.2198,1.9844,2.0098,2.1181,1.9023,1.9358,3.0544,3.0858,2.7815,3.0303,2.5748,3.2939,2.9576,3.1035,3.0019,4.0008,1.8948,1.3145,4.1800,3.5067,3.6563,4.1082,3.4460,3.4571,3.5484,3.5639,3.1149,3.3521,3.4014,3.3069,2.0812,3.2541,3.7202,3.1165,2.8746,3.3169,3.5611,3.5407,3.5707,3.5680,3.1767,3.1687,2.4631,3.3239,3.5236,3.2286,3.0945,3.0295,3.0562,3.2813,3.5876,3.6049,3.6824,3.0889,3.3272,3.2922,3.3262,3.5403,3.4736,3.2673,3.3361,2.1683,2.2940,2.4389,2.9119,3.7036,4.5331,4.5310,4.1858,3.5213,3.0767,3.0625,2.9484,2.5192,2.4895,2.5538,2.4729,2.6171,2.9052,2.3137,2.7912,2.6232,2.9184,2.0587,2.0448,2.2895,1.7324,1.8654,1.9667,2.9382,3.2572,3.2493,2.8266,3.0280,3.4462,2.9849,3.0014,1.5165,1.5932,1.9250,2.3468,1.6268,1.8531,2.3627,2.8488,3.1685,3.2419,3.3464,3.0824,3.5448,3.5362,3.5588,3.5612,3.5450,3.5600,3.2652,3.2630,3.2676,3.2810,3.2778,3.2729,3.4290,3.5717,3.7790,4.0639,2.5697,3.9719,2.5548,2.4440,2.1522,2.3050,1.9194,3.3463,3.0186,3.0984,3.1772,3.0365,3.2481,3.3834,2.9221,2.1193,2.9343,2.7009,3.2584,3.7253,2.0735,1.8889,2.0944,3.7362,2.9878,4.4664,4.2124,4.3834,3.0321,3.9954,4.0291,4.1620,4.1463,4.1174,4.0627,3.9007,3.8112,3.7005,3.6099,3.5725,3.6862,4.0492,3.8445,3.7388,2.9324,3.0207,2.5491,2.8205,3.0759,3.0102,2.7322,2.8205,3.3511,4.0131,4.0567,3.8884,3.7070,3.5829,3.9573,3.1967,2.8505,2.8444,2.9948,2.9800,2.8321,2.9842,3.0097,2.9097,2.9714,3.2265,3.7528,3.8711,3.3144,3.5251,3.5253,3.4100,3.5509,3.5704,3.4526,3.7183,3.5598,3.4514,3.0563,4.0671,4.1077,4.1853,4.1437,3.1521,3.1695,3.2124,3.1533,3.3686,3.3963,3.4330,3.2971,3.3042,3.1684,3.0011,3.1592,3.1603,3.1524,3.2718,3.7546,4.0143,4.1597,4.0583,3.8903,4.0217,3.7366,4.0544,3.7378,4.4354,4.1235,3.1246,3.4606)


BW <- 7

a<-commandArgs(T)
NAME <- a[1]
upstream <- as.numeric(a[2])
downstream <- as.numeric(a[3])
plot_custom <- a[4]
sequencing_coverage <- as.numeric(a[5])
fraglen_limit <- as.numeric(a[6])
utr_fold <- as.numeric(a[7])
DHS_fold <- as.numeric(a[8])
# array_num <- as.numeric(a[10])
# total_utr_length<- as.numeric(a[11])
# total_DHS_length<- as.numeric(a[12])
# effective_gs<- as.numeric(a[13])

#NAME <- 'GSM907784'
#upstream <- 1000
#downstream <- 2000
#plot_custom <- '1'
#sequencing_coverage <- 20
#fraglen_limit <- 250

# NAME <-'GSM1633579'
# upstream<-1000
# downstream<-2000
# plot_custom<-'0'
# sequencing_coverage<-43.6545651209
# fraglen_limit <- 250
# array_on_utr<-28168
# array_on_DHS<-172022
# array_num<-322098
# total_utr_length<-77032025
# total_DHS_length<-314387090
# effective_gs<-1870000000.0

###  start ploting
# PLOT FOR SEQUENCING COVERAGE
pdf(file=paste(NAME,'_seqCov.pdf',sep=""))
hist(seqcov_distribution,n=100,freq=F,xlab="Sequencing coverage",main="Sequencing coverage in historical data",ylab="Frequency")
abline(v=sequencing_coverage, lwd=2,col="red")
dev.off()

# PLOT FOR PROFILE ON TSS OR CUSTOMER DEFINED REGIONS
tss_profile <- read.table(paste(NAME, '_Tss_profile.txt', sep=""))
TSS <- tss_profile[ order( apply(tss_profile[,7:ncol(tss_profile)],1,mean) ) , 7:ncol(tss_profile)]

if (plot_custom == 0){
    pdf(file=paste(NAME,"_profile.pdf",sep=""),width=5)
    layout(matrix(seq(3),nrow=3),heights=c(3,5,1))
}else{
    pdf(file=paste(NAME,"_profile.pdf",sep=""),width=10)
    layout(matrix(seq(6),nrow=3,byrow=F),heights=c(3,5,1))
}

par(mar=c(4,4,4,2))
plot(apply(TSS,2,mean),type="l",col="red",axes=F, xlim=c(0, floor((upstream+downstream)/10)),xlab="Relative distance to TSS(bp)",ylab="Average signal",main="Nucleosome profile on promoter regions")
axis(side=1,at=c(0,floor(upstream/10), floor((upstream+downstream)/10)),labels=c(paste( "-",upstream,sep=""),"TSS", downstream ))
axis(side=2)
box()
#abline(v=floor(upstream/10), lty=2)
bi_siteheat(TSS,c("white","red"),0.99)

if (plot_custom == 1){
     custom_profile <- read.table(paste(NAME, '_CustomRegion_profile.txt', sep=""))
     CUSTOM <- custom_profile[ order( apply(custom_profile[,7:ncol(custom_profile)],1,mean) ) , 7:ncol(custom_profile)]
     datarange <- floor((ncol(custom_profile) - 6)/2)
     par(mar=c(4,4,4,2))
     plot(apply(CUSTOM,2,mean),type="l",col="blue",axes=F, xlim=c(0, datarange*2),xlab="Relative distance to center(bp)",ylab="Average signal",main="Nucleosome profile on custom regions")
     axis(side=1,at=c(0,datarange, datarange*2),labels=c(paste( "-",datarange*10,sep=""),"center", datarange*10 ))
     axis(side=2)
     box()
     bi_siteheat(CUSTOM,c("white","blue"),0.99)
}
dev.off()

# PLOT FOR NUCLEOSOME DEPLETION ON TSS
pdf(file=paste(NAME,"_Nucdep.pdf",sep=""),width=5,height=6)
aveTSS <- apply(TSS,2,mean)
NFR <- NFRscore_generate(aveTSS)
fuzziness <- promoter_array_score_generate(aveTSS)

hist(NFR_distribution,breaks=seq(0,1,0.02),col=c(rep("blue",20),rep("red",31)),xlab="Nucleosome depletion at TSS",main="Nucleosome depletion level in historical data",xlim=c(0,1),ylim=c(0,25))
legend("topleft",c("Pass","Fail","Input sample"),col=c("red","blue","black"),lwd=3,bty="n",cex=1.1)
abline(v=NFR,lwd=2)
dev.off()


# PLOT FOR NUCLEOSOME FUZZINESS DOWNSTREAM TSS
pdf(file=paste(NAME,"_Nucfuzz.pdf",sep=""),width=5,height=6)

if (fuzziness!=100 & fuzziness>1.3){
    fuzziness_tmp <- c(fuzziness_distribution,fuzziness)
    breaks=seq(0,max(fuzziness_tmp)+0.02,0.02)
}else{
    fuzziness_tmp <- fuzziness_distribution
    breaks=seq(0,1.3,0.02)
}
hist(fuzziness_distribution,breaks=breaks,col=c(rep("red",20),rep("blue",length(breaks)-20)),xlab="Nucleosome fuzziness downstream TSS",main="Nucleosome fuzziness in historical data",xlim=c(0,max(fuzziness_tmp)),ylim=c(0,62))
legend("topright",c("Pass","Fail","Input sample"),col=c("red","blue","black"),lwd=3,bty="n",cex=1.1)
abline(v=fuzziness,lwd=2)
dev.off()

# PLOT FOR DI-NUCLEOTIDE FREQUENCY
rotational <- read.table(paste(NAME,'_ATfrac.txt',sep=""))
rot_score <- abs(fft(rotational[,2])[15])
pdf(file=paste(NAME,"_ATfrac.pdf",sep=""),width=12)
par(mfrow=c(1,2))

if (rot_score>0.065){
    rotational_tmp <- c(rotational_distribution,rot_score)
    breaks=seq(0,max(rotational_tmp)+0.01,0.01)
}else{
    rotational_tmp <- rotational_distribution
    breaks<-seq(0,0.65,0.01)
}

hist(rotational_distribution,breaks=breaks,col=c(rep("blue",8),rep("red",length(breaks)-8)),xlab="Di-nucleotide frequency",main="Di-nucleotide frequency in historical data")
legend("topright",c("Pass","Fail","Input sample"),col=c("red","blue","black"),lwd=3,bty="n",cex=1.1)
abline(v=rot_score,lwd=2)
plot(rotational[,1],rotational[,2], type="l",col="red",xlab="Distance to 5' end (bp)",ylab="AA/TT/AT frequency",main="Di-nucleotide frequency for input sample")
dev.off()


# PLOT FOR NUCLEOSOME LENGTH
fraglen <- read.table(paste(NAME,'_fraglen.txt',sep=""))
FL <- fraglen[1:nrow(fraglen),2]
useFL <- FL[50:fraglen_limit]
nuclen <- which(FL == max(FL[100:200]))[1]

pdf(file=paste(NAME,"_fraglen.pdf",sep=""),width=12)
par(mfrow=c(1,2))
breaks <- seq(100,200,2)
hist(fraglen_distribution,breaks=breaks,col=c(rep("blue",20),rep("red",8),rep("blue",length(breaks)-28)),xlab="Nucleosomal DNA length",main="Nucleosomal DNA length in historical data",xlim=c(120,180))
abline(v=nuclen,lwd=2)
legend("topright",c("Pass","Fail","Input sample"),col=c("red","blue","black"),lwd=3,bty="n",cex=1.1)
plot(50:fraglen_limit, useFL,  type="l", col="red" ,ylab="Frequency",xlab="Fragment length (bp)", main="Fragment length distribution for input sample")
abline(v=147, lty=2)
abline(v=nuclen, lwd=2)
dev.off()

# PLOT FOR NUCLEOSOME ARRAY ENRICHMENT ON UTR OR DHS

# utr_fold <- round( (array_on_utr/array_num) / (total_utr_length/effective_gs) ,4)

# DHS_fold <- round( (array_on_DHS/array_num) / (total_DHS_length/effective_gs) ,4)

pdf(file=paste(NAME,"_utr.pdf",sep=""),width=5,height=6)

if (utr_fold>5.5){
    utr_tmp <- c(utr_distribution,utr_fold)
    breaks=seq(0.45,max(utr_tmp)+0.05,0.05)
    l1 <-length(which(breaks<1))
    l2 <-length(breaks)-l1
}else{
    utr_tmp <- utr_distribution
    breaks<-seq(0.45,5.5,0.05)
    l1<-11
    l2<-91
}

hist(utr_distribution,breaks=breaks,col=c(rep("blue",l1),rep("red",l2)),xlab="Nucleosome array enrichment on UTR",main="enrichment on UTR in historical data",ylim=c(0,22))
legend("topright",c("Pass","Fail","Input sample"),col=c("red","blue","black"),lwd=3,bty="n",cex=1.1)
abline(v=utr_fold,lwd=2)

dev.off()

pdf(file=paste(NAME,"_dhs.pdf",sep=""),width=5,height=6)

if (DHS_fold>4.6){
    dhs_tmp <- c(dhs_distribution,DHS_fold)
    breaks=seq(1.3,max(dhs_tmp)+0.05,0.05)
    l1 <-length(which(breaks<=1))
    l2 <-length(breaks)-l1
}else{
    dhs_tmp <- dhs_distribution
    breaks<-seq(1.3,4.6,0.05)
    l1<-14
    l2<-53
}

hist(dhs_distribution,breaks=breaks,col=c(rep("blue",l1),rep("red",l2)),xlab="Nucleosome array enrichment on DHS",main="Enrichment on DHS in historical data",ylim=c(0,20))
legend("topleft",c("Pass","Fail","Input sample"),col=c("red","blue","black"),lwd=3,bty="n",cex=1.1)
abline(v=DHS_fold,lwd=2)
dev.off()

print(c(rot_score, nuclen, NFR, fuzziness))

